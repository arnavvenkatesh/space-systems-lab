<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module 01: Orbital Mechanics ‚Äî Space Systems Lab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060810;
      --surface: #0c0f18;
      --surface2: #121520;
      --border: #1a2035;
      --text: #c8d4e8;
      --muted: #4a5568;
      --accent: #00d4aa;
      --accent2: #3b7eff;
      --warn: #f59e0b;
      --red: #ff4d6d;
      --white: #ffffff;
      --font: 'Outfit', sans-serif;
      --mono: 'Space Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ===== NAV ===== */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      background: rgba(6,8,16,0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 200;
    }

    .nav-logo {
      font-family: var(--mono);
      font-size: 1rem;
      color: var(--white);
      letter-spacing: 2px;
    }
    .nav-logo span { color: var(--accent); }

    .nav-breadcrumb {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .nav-breadcrumb a { color: var(--muted); text-decoration: none; }
    .nav-breadcrumb a:hover { color: var(--accent); }
    .nav-breadcrumb .sep { margin: 0 0.5rem; }

    .nav-right a {
      font-size: 0.82rem;
      color: var(--muted);
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 0.35rem 0.9rem;
      border-radius: 4px;
      transition: color 0.2s, border-color 0.2s;
    }
    .nav-right a:hover { color: var(--accent); border-color: var(--accent); }

    /* ===== HEADER ===== */
    .module-header {
      padding: 3rem 2rem 2rem;
      max-width: 1300px;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .module-tag {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--accent);
      letter-spacing: 3px;
      text-transform: uppercase;
      display: block;
      margin-bottom: 0.75rem;
    }

    .module-header h1 {
      font-size: clamp(2rem, 4vw, 3.2rem);
      font-weight: 800;
      color: var(--white);
      letter-spacing: -1.5px;
      line-height: 1.1;
      margin-bottom: 0.75rem;
    }

    .module-header p {
      color: var(--muted);
      font-size: 0.95rem;
      max-width: 480px;
      line-height: 1.7;
    }

    .module-pills {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 0.72rem;
      font-family: var(--mono);
      padding: 0.25rem 0.7rem;
      border-radius: 100px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    /* ===== MAIN LAYOUT ===== */
    .simulator-layout {
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 2rem 4rem;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1.5rem;
      align-items: start;
    }

    /* ===== CONTROLS PANEL ===== */
    .controls-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      position: sticky;
      top: 80px;
    }

    .panel-title {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .control-group {
      margin-bottom: 1.75rem;
    }

    .control-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.6rem;
      gap: 0.5rem;
    }

    .control-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    /* Tooltip trigger */
    .info-btn {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--muted);
      background: none;
      color: var(--muted);
      font-size: 0.6rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
      transition: border-color 0.2s, color 0.2s;
      font-family: var(--mono);
      line-height: 1;
      padding: 0;
    }

    .info-btn:hover { border-color: var(--accent); color: var(--accent); }

    .info-btn .tooltip {
      position: absolute;
      left: 24px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--surface2);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 0.9rem 1rem;
      width: 220px;
      font-size: 0.78rem;
      color: var(--text);
      line-height: 1.6;
      z-index: 300;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      font-family: var(--font);
      font-weight: 400;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }

    .info-btn .tooltip::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 50%;
      transform: translateY(-50%);
      border: 5px solid transparent;
      border-right-color: var(--accent);
      border-left: none;
    }

    .info-btn:hover .tooltip { opacity: 1; }

    .control-value {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--accent);
      white-space: nowrap;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: var(--border);
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 0 6px rgba(0,212,170,0.4);
    }

    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }

    .range-bounds {
      display: flex;
      justify-content: space-between;
      margin-top: 0.3rem;
    }

    .range-bounds span {
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--muted);
    }

    /* Toggle buttons */
    .toggle-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .toggle-btn {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      font-size: 0.78rem;
      font-family: var(--font);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      white-space: nowrap;
    }

    .toggle-btn.active {
      background: rgba(0,212,170,0.12);
      border-color: var(--accent);
      color: var(--accent);
    }

    .hohmann-btn {
      width: 100%;
      padding: 0.75rem;
      background: rgba(59,126,255,0.1);
      border: 1px solid var(--accent2);
      border-radius: 8px;
      color: var(--accent2);
      font-size: 0.85rem;
      font-family: var(--font);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .hohmann-btn:hover {
      background: rgba(59,126,255,0.2);
      transform: translateY(-1px);
    }

    .hohmann-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    /* Live readouts */
    .readouts {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    .readout-title {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .readout-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.35rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .readout-row:last-child { border-bottom: none; }

    .readout-key {
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .readout-val {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--white);
    }

    .readout-val.green { color: var(--accent); }
    .readout-val.blue { color: var(--accent2); }
    .readout-val.amber { color: var(--warn); }

    /* ===== CANVAS AREA ===== */
    .canvas-area {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .canvas-wrapper {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .canvas-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .canvas-title {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .canvas-controls {
      display: flex;
      gap: 0.5rem;
    }

    .canvas-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 0.3rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      font-family: var(--mono);
      transition: all 0.2s;
    }

    .canvas-btn:hover, .canvas-btn.active { color: var(--accent); border-color: var(--accent); }

    canvas {
      display: block;
      width: 100%;
      background: transparent;
    }

    /* ===== PHYSICS EXPLAINER ===== */
    .physics-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .physics-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      cursor: default;
      transition: border-color 0.2s, transform 0.2s;
    }

    .physics-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .phys-icon { font-size: 1.5rem; margin-bottom: 0.6rem; }

    .phys-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 0.4rem;
    }

    .phys-formula {
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .phys-desc {
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.6;
    }

    /* ===== STATUS BAR ===== */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0.6rem 1.2rem;
      background: var(--surface2);
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-family: var(--mono);
      font-size: 0.68rem;
      color: var(--muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Hohmann overlay label */
    .hohmann-label {
      position: absolute;
      top: 50px;
      right: 16px;
      background: rgba(59,126,255,0.15);
      border: 1px solid var(--accent2);
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      font-family: var(--mono);
      font-size: 0.68rem;
      color: var(--accent2);
      pointer-events: none;
      display: none;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .simulator-layout {
        grid-template-columns: 1fr;
        padding: 0 1rem 3rem;
      }
      .controls-panel { position: static; }
      .physics-cards { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 600px) {
      .physics-cards { grid-template-columns: 1fr; }
      .module-header { padding: 2rem 1rem 1.5rem; }
      nav { padding: 0.75rem 1rem; }
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-logo">SSL<span>.</span></div>
  <div class="nav-breadcrumb">
    <a href="modules.html">Modules</a>
    <span class="sep">/</span>
    <span>01 ‚Äî Orbital Mechanics</span>
  </div>
  <div class="nav-right">
    <a href="modules.html">‚Üê Back to Modules</a>
  </div>
</nav>

<!-- HEADER -->
<div class="module-header">
  <div>
    <span class="module-tag">Module 01</span>
    <h1>Orbital<br>Mechanics</h1>
    <p>Adjust orbital parameters and watch the physics respond in real time. Hover the <strong style="color:var(--accent)">‚ìò</strong> icons to learn the physics behind each control.</p>
    <div class="module-pills">
      <span class="pill">Interactive</span>
      <span class="pill">2D Simulation</span>
      <span class="pill">Beginner‚ÄìIntermediate</span>
    </div>
  </div>
</div>

<!-- SIMULATOR -->
<div class="simulator-layout">

  <!-- CONTROLS -->
  <div class="controls-panel">
    <div class="panel-title">// Parameters</div>

    <!-- Altitude -->
    <div class="control-group">
      <div class="control-label-row">
        <div class="control-label">
          Altitude
          <button class="info-btn" tabindex="-1">i
            <div class="tooltip">
              <strong style="color:var(--accent)">Orbital Altitude</strong><br><br>
              The height above Earth's surface. As altitude increases, the satellite must travel a longer path around Earth. Gravity weakens with distance (Newton's law: F = GMm/r¬≤), so higher orbits require less velocity but take longer to complete.
            </div>
          </button>
        </div>
        <span class="control-value" id="alt-display">400 km</span>
      </div>
      <input type="range" id="altitude" min="200" max="36000" value="400" step="50">
      <div class="range-bounds"><span>200 km (LEO)</span><span>36,000 km (GEO)</span></div>
    </div>

    <!-- Velocity -->
    <div class="control-group">
      <div class="control-label-row">
        <div class="control-label">
          Velocity
          <button class="info-btn" tabindex="-1">i
            <div class="tooltip">
              <strong style="color:var(--accent)">Orbital Velocity</strong><br><br>
              The speed of the satellite. At circular orbital velocity (v = ‚àö(GM/r)), gravity perfectly balances the centrifugal tendency. Going faster raises the orbit on the opposite side, creating an ellipse. Going slower drops it ‚Äî this is how Hohmann transfers work.
            </div>
          </button>
        </div>
        <span class="control-value" id="vel-display">7.67 km/s</span>
      </div>
      <input type="range" id="velocity" min="30" max="170" value="100" step="1">
      <div class="range-bounds"><span>Slower (ellipse)</span><span>Faster (ellipse)</span></div>
    </div>

    <!-- Orbit type -->
    <div class="control-group">
      <div class="control-label-row">
        <div class="control-label">
          Orbit Shape
          <button class="info-btn" tabindex="-1">i
            <div class="tooltip">
              <strong style="color:var(--accent)">Circular vs Elliptical</strong><br><br>
              A circular orbit has constant speed and altitude. An elliptical orbit follows Kepler's 1st Law ‚Äî the planet sits at one focus. The satellite speeds up at periapsis (closest point) and slows at apoapsis (farthest), conserving orbital energy.
            </div>
          </button>
        </div>
      </div>
      <div class="toggle-row">
        <button class="toggle-btn active" id="btn-circular" onclick="setOrbitType('circular')">Circular</button>
        <button class="toggle-btn" id="btn-elliptical" onclick="setOrbitType('elliptical')">Elliptical</button>
      </div>
    </div>

    <!-- Eccentricity (shows when elliptical) -->
    <div class="control-group" id="ecc-group" style="display:none">
      <div class="control-label-row">
        <div class="control-label">
          Eccentricity
          <button class="info-btn" tabindex="-1">i
            <div class="tooltip">
              <strong style="color:var(--accent)">Orbital Eccentricity (e)</strong><br><br>
              Describes how "stretched" an orbit is. e = 0 is a perfect circle. e closer to 1 is a very elongated ellipse. Eccentricity is derived from the orbital energy and angular momentum of the satellite.
            </div>
          </button>
        </div>
        <span class="control-value" id="ecc-display">e = 0.30</span>
      </div>
      <input type="range" id="eccentricity" min="5" max="85" value="30" step="1">
      <div class="range-bounds"><span>e ‚âà 0 (rounder)</span><span>e ‚âà 0.9 (elongated)</span></div>
    </div>

    <!-- Hohmann transfer -->
    <div class="control-group">
      <div class="control-label-row">
        <div class="control-label">
          Hohmann Transfer
          <button class="info-btn" tabindex="-1">i
            <div class="tooltip">
              <strong style="color:var(--accent)">Hohmann Transfer Orbit</strong><br><br>
              The most fuel-efficient way to move between two circular orbits. It uses two engine burns: the first burn creates an ellipse that just touches the target orbit; the second circularizes at the target. Conceived by Walter Hohmann in 1925.
            </div>
          </button>
        </div>
      </div>
      <input type="range" id="target-alt" min="200" max="36000" value="2000" step="100">
      <div class="control-label-row" style="margin-top:0.3rem">
        <span style="font-size:0.75rem; color:var(--muted)">Target altitude</span>
        <span class="control-value" id="target-display">2,000 km</span>
      </div>
      <button class="hohmann-btn" id="hohmann-btn" onclick="triggerHohmann()">‚ñ∂ Simulate Transfer</button>
    </div>

    <!-- Live readouts -->
    <div class="readouts">
      <div class="readout-title">// Live Telemetry</div>
      <div class="readout-row">
        <span class="readout-key">Orbital Period</span>
        <span class="readout-val green" id="r-period">‚Äî</span>
      </div>
      <div class="readout-row">
        <span class="readout-key">Orbital Radius</span>
        <span class="readout-val" id="r-radius">‚Äî</span>
      </div>
      <div class="readout-row">
        <span class="readout-key">Circ. Velocity</span>
        <span class="readout-val blue" id="r-circvel">‚Äî</span>
      </div>
      <div class="readout-row">
        <span class="readout-key">Orbit Type</span>
        <span class="readout-val amber" id="r-type">Circular</span>
      </div>
      <div class="readout-row">
        <span class="readout-key">Œîv (Hohmann)</span>
        <span class="readout-val" id="r-dv">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDE: CANVAS + PHYSICS CARDS -->
  <div class="canvas-area">

    <div class="canvas-wrapper">
      <div class="canvas-toolbar">
        <span class="canvas-title">// Orbit Visualizer ‚Äî Real-time 2D</span>
        <div class="canvas-controls">
          <button class="canvas-btn active" id="btn-trail" onclick="toggleTrail()">Trail ON</button>
          <button class="canvas-btn" id="btn-labels" onclick="toggleLabels()">Labels</button>
          <button class="canvas-btn" onclick="resetSim()">Reset</button>
        </div>
      </div>

      <canvas id="orbitCanvas" width="760" height="500"></canvas>

      <div id="hohmann-label" class="hohmann-label">HOHMANN TRANSFER IN PROGRESS</div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot"></div>
          <span>SIMULATION RUNNING</span>
        </div>
        <div class="status-item">FRAME: <span id="s-frame" style="color:var(--text); margin-left:4px">0</span></div>
        <div class="status-item">SPEED: <span style="color:var(--accent); margin-left:4px">1000√ó</span></div>
        <div class="status-item" id="s-phase" style="color:var(--accent2)"></div>
      </div>
    </div>

    <!-- Physics cards -->
    <div class="physics-cards">
      <div class="physics-card">
        <div class="phys-icon">üåç</div>
        <div class="phys-title">Newton's Gravitation</div>
        <div class="phys-formula">F = GMm / r¬≤</div>
        <div class="phys-desc">Gravity pulls the satellite toward Earth with a force that decreases with the square of the distance. This centripetal force is what keeps the satellite in orbit instead of flying off into space.</div>
      </div>
      <div class="physics-card">
        <div class="phys-icon">‚ö°</div>
        <div class="phys-title">Conservation of Energy</div>
        <div class="phys-formula">E = ¬Ωmv¬≤ ‚àí GMm/r</div>
        <div class="phys-desc">Total orbital energy is the sum of kinetic and potential energy. It stays constant in a closed orbit. This is why speeding up raises your orbit ‚Äî you're adding energy to the system.</div>
      </div>
      <div class="physics-card">
        <div class="phys-icon">üîÑ</div>
        <div class="phys-title">Kepler's Third Law</div>
        <div class="phys-formula">T¬≤ ‚àù a¬≥</div>
        <div class="phys-desc">The orbital period squared is proportional to the semi-major axis cubed. Higher orbits = longer periods. The ISS completes an orbit every 92 minutes; the Moon takes 27 days.</div>
      </div>
    </div>

  </div>
</div>

<script>
// ============================================================
// ORBITAL MECHANICS SIMULATOR
// Space Systems Lab ‚Äî Module 01
// ============================================================

const canvas = document.getElementById('orbitCanvas');
const ctx = canvas.getContext('2d');

// Physical constants
const G = 6.674e-11;
const M_EARTH = 5.972e24;
const R_EARTH = 6371e3; // meters

// Simulation state
let state = {
  altitude: 400e3,       // meters
  velFactor: 1.0,        // multiplier on circular velocity
  orbitType: 'circular',
  eccentricity: 0.3,
  targetAlt: 2000e3,
  showTrail: true,
  showLabels: false,
  hohmannActive: false,
  hohmannPhase: 0,       // 0=idle, 1=transfer arc, 2=circularizing
  hohmannProgress: 0,
  frameCount: 0,
  satAngle: 0,           // current angle of sat on orbit (radians)
  transferAngle: 0,      // angle progress through transfer ellipse
};

// Canvas helpers
function getCenter() {
  const r = canvas.getBoundingClientRect();
  return { cx: canvas.width / 2, cy: canvas.height / 2 };
}

function earthRadius() {
  return Math.min(canvas.width, canvas.height) * 0.085;
}

// Map real orbit radius to canvas pixels
// LEO (6571km) ‚Üí small, GEO (42164km) ‚Üí big
// Use log scale for better visualization
function orbitToPixels(rMeters) {
  const rKm = rMeters / 1e3;
  const minR = R_EARTH / 1e3;       // ~6371
  const maxR = 42164 + 1000;        // just beyond GEO

  const eR = earthRadius();
  const maxPx = Math.min(canvas.width, canvas.height) * 0.46;

  const logMin = Math.log(minR);
  const logMax = Math.log(maxR);
  const logR = Math.log(rKm);

  const t = (logR - logMin) / (logMax - logMin);
  return eR + t * (maxPx - eR);
}

function circularVelocity(r) {
  return Math.sqrt(G * M_EARTH / r); // m/s
}

function orbitalPeriod(a) {
  return 2 * Math.PI * Math.sqrt(a * a * a / (G * M_EARTH)); // seconds
}

function formatPeriod(s) {
  if (s < 3600) return (s / 60).toFixed(1) + ' min';
  return (s / 3600).toFixed(2) + ' hr';
}

// Draw starfield (static)
let stars = [];
function initStars() {
  stars = [];
  for (let i = 0; i < 180; i++) {
    stars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 1.2,
      a: Math.random() * 0.6 + 0.1
    });
  }
}
initStars();

function drawStars() {
  stars.forEach(s => {
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(200,212,240,${s.a})`;
    ctx.fill();
  });
}

// Draw Earth
function drawEarth(cx, cy) {
  const er = earthRadius();
  // Glow
  const glow = ctx.createRadialGradient(cx, cy, er * 0.5, cx, cy, er * 2);
  glow.addColorStop(0, 'rgba(30,80,200,0.15)');
  glow.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.beginPath();
  ctx.arc(cx, cy, er * 2, 0, Math.PI * 2);
  ctx.fillStyle = glow;
  ctx.fill();

  // Earth body
  const earthGrad = ctx.createRadialGradient(cx - er * 0.2, cy - er * 0.2, er * 0.1, cx, cy, er);
  earthGrad.addColorStop(0, '#3a90e8');
  earthGrad.addColorStop(0.4, '#1a5bb5');
  earthGrad.addColorStop(0.7, '#0f3d82');
  earthGrad.addColorStop(1, '#071f50');
  ctx.beginPath();
  ctx.arc(cx, cy, er, 0, Math.PI * 2);
  ctx.fillStyle = earthGrad;
  ctx.fill();

  // Atmosphere ring
  ctx.beginPath();
  ctx.arc(cx, cy, er + 4, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(100,180,255,0.3)';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Earth label
  if (state.showLabels) {
    ctx.fillStyle = 'rgba(180,200,240,0.6)';
    ctx.font = `${Math.floor(earthRadius() * 0.3)}px 'Space Mono', monospace`;
    ctx.textAlign = 'center';
    ctx.fillText('EARTH', cx, cy + er + 18);
  }
}

// Draw orbit path
function drawOrbitPath(cx, cy, a, b, color, dash) {
  ctx.save();
  ctx.beginPath();
  if (dash) ctx.setLineDash(dash);
  ctx.ellipse(cx, cy, a, b, 0, 0, Math.PI * 2);
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();
}

// Satellite trail
let trail = [];

function drawSatellite(x, y, angle) {
  // Trail
  if (state.showTrail) {
    trail.push({ x, y, age: 0 });
    if (trail.length > 120) trail.shift();
    trail.forEach((p, i) => {
      p.age++;
      const alpha = Math.max(0, 0.5 - p.age / 120);
      ctx.beginPath();
      ctx.arc(p.x, p.y, 1.5, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(0,212,170,${alpha})`;
      ctx.fill();
    });
  }

  // Satellite body
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(angle + Math.PI / 2);

  // Body
  ctx.fillStyle = '#c8d4e8';
  ctx.fillRect(-4, -6, 8, 12);

  // Solar panels
  ctx.fillStyle = '#2563eb';
  ctx.fillRect(-14, -3, 10, 6);
  ctx.fillRect(4, -3, 10, 6);

  // Glow
  ctx.restore();
  const satGlow = ctx.createRadialGradient(x, y, 0, x, y, 12);
  satGlow.addColorStop(0, 'rgba(0,212,170,0.4)');
  satGlow.addColorStop(1, 'rgba(0,212,170,0)');
  ctx.beginPath();
  ctx.arc(x, y, 12, 0, Math.PI * 2);
  ctx.fillStyle = satGlow;
  ctx.fill();
}

// Orbit type label on canvas
function drawOrbitLabel(cx, cy, aPx, label, color) {
  if (!state.showLabels) return;
  ctx.fillStyle = color;
  ctx.font = "10px 'Space Mono', monospace";
  ctx.textAlign = 'center';
  ctx.fillText(label, cx, cy - aPx - 10);
}

// ======= MAIN DRAW =======
function draw() {
  // Resize canvas to wrapper
  const wrapper = canvas.parentElement;
  const dpr = window.devicePixelRatio || 1;
  const displayW = wrapper.clientWidth;
  const displayH = Math.max(380, Math.min(520, displayW * 0.62));

  if (canvas.width !== displayW || canvas.height !== displayH) {
    canvas.width = displayW;
    canvas.height = displayH;
    canvas.style.height = displayH + 'px';
    initStars();
    trail = [];
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Background
  ctx.fillStyle = '#060810';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawStars();

  const cx = canvas.width / 2;
  const cy = canvas.height / 2;

  const r = R_EARTH + state.altitude;
  const aPx = orbitToPixels(r);

  // Determine orbit shape
  let bPx = aPx;
  let ecc = 0;

  if (state.orbitType === 'elliptical') {
    ecc = state.eccentricity;
    // b = a * sqrt(1 - e¬≤)
    bPx = aPx * Math.sqrt(1 - ecc * ecc);
  }

  // Velocity deviation from circular
  const vcirk = circularVelocity(r);
  const actualVel = vcirk * state.velFactor;

  // Compute "effective eccentricity" from vel factor for visual
  const velEcc = Math.abs(state.velFactor - 1.0) * 1.2;
  if (state.orbitType === 'circular' && velEcc > 0.02) {
    bPx = aPx * Math.sqrt(1 - Math.min(velEcc, 0.9) * Math.min(velEcc, 0.9));
    ecc = Math.min(velEcc, 0.9);
  }

  // --- Draw orbit grid rings (faint reference) ---
  const refAlts = [400, 2000, 20200, 36000];
  refAlts.forEach(altKm => {
    const rRef = R_EARTH + altKm * 1e3;
    const pxRef = orbitToPixels(rRef);
    ctx.beginPath();
    ctx.arc(cx, cy, pxRef, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx.lineWidth = 1;
    ctx.stroke();
    if (state.showLabels) {
      ctx.fillStyle = 'rgba(100,120,160,0.5)';
      ctx.font = "9px 'Space Mono', monospace";
      ctx.textAlign = 'left';
      const label = altKm < 1000 ? altKm + ' km' : (altKm / 1000).toFixed(0) + ',000 km';
      ctx.fillText(label, cx + pxRef + 4, cy + 3);
    }
  });

  // --- Draw current orbit ---
  const orbitColor = state.orbitType === 'circular' && velEcc < 0.02
    ? 'rgba(0,212,170,0.5)'
    : 'rgba(245,158,11,0.5)';
  drawOrbitPath(cx, cy, aPx, bPx, orbitColor, null);
  drawOrbitLabel(cx, cy, aPx, state.orbitType === 'circular' ? 'CIRCULAR ORBIT' : 'ELLIPTICAL ORBIT',
    orbitColor.replace('0.5', '0.8'));

  // --- Hohmann transfer arc ---
  if (state.hohmannActive) {
    const rTarget = R_EARTH + state.targetAlt;
    const aPxTarget = orbitToPixels(rTarget);

    // Target orbit
    drawOrbitPath(cx, cy, aPxTarget, aPxTarget, 'rgba(59,126,255,0.4)', [6, 4]);
    drawOrbitLabel(cx, cy, aPxTarget, 'TARGET ORBIT', 'rgba(59,126,255,0.7)');

    // Transfer ellipse (semi-major = avg of two radii)
    const aTransfer = (aPx + aPxTarget) / 2;
    const bTransfer = Math.sqrt(aPx * aPxTarget); // geometric mean for Hohmann
    drawOrbitPath(cx, cy, aTransfer, bTransfer, 'rgba(255,77,109,0.6)', [4, 3]);

    // Show target sat position placeholder
    ctx.beginPath();
    ctx.arc(cx - aPxTarget, cy, 5, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(59,126,255,0.6)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // --- Satellite position ---
  // Parametric on ellipse
  const speed = 0.004 * (state.velFactor > 0 ? 1 / state.velFactor : 1);
  state.satAngle -= speed;

  let satX, satY;
  if (state.hohmannActive) {
    state.transferAngle -= speed * 0.6;
    const rTarget = R_EARTH + state.targetAlt;
    const aPxTarget = orbitToPixels(rTarget);
    const aT = (aPx + aPxTarget) / 2;
    const bT = Math.sqrt(aPx * aPxTarget);
    const prog = (state.transferAngle % (Math.PI * 2));
    satX = cx + aT * Math.cos(prog);
    satY = cy + bT * Math.sin(prog);
    document.getElementById('s-phase').textContent = 'TRANSFER ARC ACTIVE';
  } else {
    satX = cx + aPx * Math.cos(state.satAngle);
    satY = cy + bPx * Math.sin(state.satAngle);
    document.getElementById('s-phase').textContent = '';
  }

  drawSatellite(satX, satY, state.satAngle);
  drawEarth(cx, cy);

  // Perigee / apogee labels
  if (state.showLabels && (ecc > 0.05)) {
    ctx.fillStyle = 'rgba(245,158,11,0.8)';
    ctx.font = "9px 'Space Mono', monospace";
    ctx.textAlign = 'center';
    ctx.fillText('PERIAPSIS', cx + aPx + 20, cy - 10);
    ctx.fillText('APOAPSIS', cx - aPx - 20, cy - 10);
  }

  // Frame counter
  state.frameCount++;
  document.getElementById('s-frame').textContent = state.frameCount;

  updateReadouts();
  requestAnimationFrame(draw);
}

// ======= READOUTS =======
function updateReadouts() {
  const r = R_EARTH + state.altitude;
  const vcirk = circularVelocity(r);
  const T = orbitalPeriod(r);

  document.getElementById('r-period').textContent = formatPeriod(T);
  document.getElementById('r-radius').textContent = (r / 1e6).toFixed(4) + ' √ó 10‚Å∂ m';
  document.getElementById('r-circvel').textContent = (vcirk / 1e3).toFixed(2) + ' km/s';

  const velEcc = Math.abs(state.velFactor - 1.0) * 1.2;
  const isCircular = state.orbitType === 'circular' && velEcc < 0.02;
  document.getElementById('r-type').textContent = isCircular ? 'Circular' : 'Elliptical';
  document.getElementById('r-type').className = 'readout-val ' + (isCircular ? 'green' : 'amber');

  // Delta-v for Hohmann
  const r2 = R_EARTH + state.targetAlt;
  const vc1 = circularVelocity(r);
  const vc2 = circularVelocity(r2);
  const aT = (r + r2) / 2;
  const vt1 = Math.sqrt(G * M_EARTH * (2 / r - 1 / aT));
  const vt2 = Math.sqrt(G * M_EARTH * (2 / r2 - 1 / aT));
  const dv1 = Math.abs(vt1 - vc1) / 1e3;
  const dv2 = Math.abs(vc2 - vt2) / 1e3;
  document.getElementById('r-dv').textContent = '+' + (dv1 + dv2).toFixed(2) + ' km/s total';
}

// ======= CONTROLS =======
function updateAltitude() {
  const km = parseInt(document.getElementById('altitude').value);
  state.altitude = km * 1e3;
  document.getElementById('alt-display').textContent = km.toLocaleString() + ' km';

  const vcirk = circularVelocity(R_EARTH + state.altitude);
  document.getElementById('vel-display').textContent = (vcirk * state.velFactor / 1e3).toFixed(2) + ' km/s';

  state.hohmannActive = false;
  document.getElementById('hohmann-label').style.display = 'none';
  trail = [];
}

function updateVelocity() {
  const val = parseInt(document.getElementById('velocity').value);
  // Map slider 30‚Äì170 ‚Üí velFactor 0.6‚Äì1.4
  state.velFactor = 0.6 + (val - 30) / 140 * 0.8;

  const vcirk = circularVelocity(R_EARTH + state.altitude);
  document.getElementById('vel-display').textContent = (vcirk * state.velFactor / 1e3).toFixed(2) + ' km/s';
  trail = [];
}

function updateEccentricity() {
  const val = parseInt(document.getElementById('eccentricity').value);
  state.eccentricity = val / 100;
  document.getElementById('ecc-display').textContent = 'e = ' + state.eccentricity.toFixed(2);
  trail = [];
}

function updateTargetAlt() {
  const km = parseInt(document.getElementById('target-alt').value);
  state.targetAlt = km * 1e3;
  document.getElementById('target-display').textContent = km.toLocaleString() + ' km';
}

function setOrbitType(type) {
  state.orbitType = type;
  document.getElementById('btn-circular').className = 'toggle-btn' + (type === 'circular' ? ' active' : '');
  document.getElementById('btn-elliptical').className = 'toggle-btn' + (type === 'elliptical' ? ' active' : '');
  document.getElementById('ecc-group').style.display = type === 'elliptical' ? 'block' : 'none';
  trail = [];
}

function triggerHohmann() {
  state.hohmannActive = !state.hohmannActive;
  state.transferAngle = state.satAngle;
  const btn = document.getElementById('hohmann-btn');
  const label = document.getElementById('hohmann-label');
  if (state.hohmannActive) {
    btn.textContent = '‚ñ† Stop Transfer';
    btn.style.background = 'rgba(255,77,109,0.1)';
    btn.style.borderColor = 'var(--red)';
    btn.style.color = 'var(--red)';
    label.style.display = 'block';
    trail = [];
  } else {
    btn.textContent = '‚ñ∂ Simulate Transfer';
    btn.style.background = 'rgba(59,126,255,0.1)';
    btn.style.borderColor = 'var(--accent2)';
    btn.style.color = 'var(--accent2)';
    label.style.display = 'none';
  }
}

function toggleTrail() {
  state.showTrail = !state.showTrail;
  const btn = document.getElementById('btn-trail');
  btn.textContent = state.showTrail ? 'Trail ON' : 'Trail OFF';
  btn.className = 'canvas-btn' + (state.showTrail ? ' active' : '');
  trail = [];
}

function toggleLabels() {
  state.showLabels = !state.showLabels;
  const btn = document.getElementById('btn-labels');
  btn.textContent = state.showLabels ? 'Labels ON' : 'Labels';
  btn.className = 'canvas-btn' + (state.showLabels ? ' active' : '');
}

function resetSim() {
  document.getElementById('altitude').value = 400;
  document.getElementById('velocity').value = 100;
  document.getElementById('eccentricity').value = 30;
  document.getElementById('target-alt').value = 2000;
  state.altitude = 400e3;
  state.velFactor = 1.0;
  state.eccentricity = 0.3;
  state.targetAlt = 2000e3;
  state.hohmannActive = false;
  state.orbitType = 'circular';
  state.satAngle = 0;
  setOrbitType('circular');
  document.getElementById('alt-display').textContent = '400 km';
  document.getElementById('vel-display').textContent = '7.67 km/s';
  document.getElementById('target-display').textContent = '2,000 km';
  document.getElementById('hohmann-btn').textContent = '‚ñ∂ Simulate Transfer';
  document.getElementById('hohmann-btn').style.cssText = '';
  document.getElementById('hohmann-label').style.display = 'none';
  document.getElementById('s-phase').textContent = '';
  trail = [];
}

// Wire up event listeners
document.getElementById('altitude').addEventListener('input', updateAltitude);
document.getElementById('velocity').addEventListener('input', updateVelocity);
document.getElementById('eccentricity').addEventListener('input', updateEccentricity);
document.getElementById('target-alt').addEventListener('input', updateTargetAlt);

// Start
updateReadouts();
draw();
</script>

</body>
</html>
